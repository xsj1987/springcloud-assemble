### Hystrix简介
Hystrix是由Netflix开源的一个延迟和容错库，用于隔离访问远程系统、服务或者第三方库，防止级联失败，从而提升系统的可用性与容错性。
* 包裹请求：使用HystrixCommand包裹对依赖的调用逻辑，每个命令在独立线程中执行。
* 跳闸机制：当某服务的错误率超过一定阈值时，Hystrix可以自动或手动跳闸，停止请求该服务一段时间
* 资源隔离：Hystrix为每个依赖都维护了一个小型的线程池(信号量)。如果该线程池已满，发往该依赖的请求就被立即拒绝，而不是排队等候，从而加速失败判定
* 监控：Hystrix可以实时监控运行指标和配置的变化，例如成功、失败、超时以及被拒绝的请求等
* 回退机制：当请求失败、超时、被拒绝，或当断路器打开时，执行回退逻辑，该逻辑由开发人员提供
* 自我修复：断路器打开一段时间后，会自动进入"半开"状态
### 雪崩效应
在微服务架构系统中，微服务之间通过网络进行通信，相互依赖，当某一个服务不可用时而导致的级联故障称为雪崩效应。它描述的是提供者不可用导致消费者不可用，并将不可用逐渐放大的过程。
### 防止雪崩效应
防止雪崩效应需要有一个强大的容错机制，该容错机制需要实现两点
1. 为网络请求设置超时，即为每个网络请求设置超时，让资源尽快释放
2. 使用断路器模式，断路器可以统计一段时间内调用失败的次数，并决定是正常请求依赖的服务还是直接返回。也可以实现快速失败，即如果它在一段时间内检测到许多类似的错误，就会在之后的一段时间内，强迫对该服务的调用快速失败。还可以自动诊断依赖的服务是否已经恢复正常，即如果发现依赖的服务已经恢复正常，那么就会恢复请求该服务。
### Hystrix配置
1. 引入依赖
```java
<!-- 引入Hystrix依赖 -->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-hystrix</artifactId>
</dependency>
```
2. 在启动类上添加@EnableCircuitBreaker或者@EnableHystrix，为项目添加断路器支持
3. 在请求方法上添加@HystrixCommand(fallbackMethod = "findByIdFallback")注解，fallbackMethod表示回退方法，该方法需要开发者自定义。回退的方法参数与返回值跟注解的方法相同。
### Hystrix线程隔离策略与传播上下文
隔离策略有两种
* THREAD(线程隔离[默认])：该策略会让HystrixCommand在单独的线程上执行，并发请求受线程池中的线程数量的限制
* SEMAPHORE(信号量隔离)：该策略会让HystrixCommand在调用线程上执行，开销较小，并发请求受到信号量个数的限制
